{% load static %}
  <table class="cart">
    <thead>
<tr>
<th>Изображение</th>
<th>Продукт</th>
<th>Количество</th>
<th>Удалить</th>
<th>Цена</th>
<th>Итоговая Цена</th>
</tr>
</thead>
<tbody>
      {% for item in cart %}
        {% with product=item.product %}
<tr>
<td>
<a href="{{ product.get_absolute_url }}">
  {% if product.get_first_photo %}
    <img src="{{ product.get_first_photo }}" alt="">
  {% else %}
    <img src="{% static 'img/no_image.png' %}" width="100">
  {% endif %}
</a>
</td>
<td>{{ product.title }}</td>
<td>
  <form action="{% url 'cart_add' product.id %}" method='post' class="quantity-form">
                    {% csrf_token %}

                    <button type="button" class="quantity-btn minus" style=color:white; data-product-id="{{ product.id }}">-</button>

                    <input type="number" name="quantity" value="{{ item.quantity }}" min="1" 
                           class="quantity-input" id="quantity-{{ product.id }}">
                    <button type="button" class="quantity-btn plus" style=color:white;
                    data-product-id="{{ product.id }}">+</button>

                    <input type="hidden" name="override" value="true">
                    <button type="submit" style="display:none" id="submit-{{ product.id }}">Обновить</button>
                </form>
</td>
<td>
<form action="{% url "cart_remove" product.id %}"
method="post">
<input type="submit" value="Удалить">
                {% csrf_token %}
</form>
</td>
<td class="num">{{ item.price }}₽</td>
<td class="num">{{ item.total_price }}₽</td>
</tr>
        {% endwith %}
      {% endfor %}
<tr class="total">
<td>Итого</td>
<td colspan="4"></td>
<td class="num">{{ cart.get_total_price }}₽</td>
</tr>
</tbody>
</table>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Обработчики для кнопок + и -
    document.querySelectorAll('.quantity-btn.plus').forEach(btn => {
        btn.addEventListener('click', function() {
            const productId = this.getAttribute('data-product-id');
            const input = document.getElementById(`quantity-${productId}`);
            input.value = parseInt(input.value) + 1;
            document.getElementById(`submit-${productId}`).click();
        });
    });

    document.querySelectorAll('.quantity-btn.minus').forEach(btn => {
        btn.addEventListener('click', function() {
            const productId = this.getAttribute('data-product-id');
            const input = document.getElementById(`quantity-${productId}`);
            if (parseInt(input.value) > 1) {
                input.value = parseInt(input.value) - 1;
                document.getElementById(`submit-${productId}`).click();
            }
        });
    });

    // Обработчик для прямого ввода числа
    document.querySelectorAll('.quantity-input').forEach(input => {
        input.addEventListener('change', function() {
            const productId = this.id.split('-')[1];
            if (this.value < 1) this.value = 1;
            document.getElementById(`submit-${productId}`).click();
        });
    });
});
</script>
